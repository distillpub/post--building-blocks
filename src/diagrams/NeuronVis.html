<div class="act-expl" style="--img-size: {{sizes.img}}px; --ptr-size: {{sizes.ptr}}px;">
  <div class="image-container">
    <img src="examples/input_images/{{example}}.png" />
  </div>

  <svg class="pointer-container" viewBox="0 0 {{sizes.ptr/sizes.img*N[0]}} {{N[1]}}">
    <filter id="background-rect-blur">
      <feGaussianBlur in="SourceGraphic" stdDeviation="0.02" />
    </filter>

    {{#each range(N[0]) as x}}
    {{#each range(N[1]) as y}}
      <rect x={{x-0.05}} y={{y-0.05}} width=1.1 height=1.1
        class={{(x == pos[0] && y == pos[1])? "background" : "unselected"}}></rect>

      <rect x={{x}} y={{y}} width=1 height=1
        class={{(x == pos[0] && y == pos[1])? "selected" : "unselected"}}
        on:mouseover='set({pos: [x,y]})'></rect>
    {{/each}}
    {{/each}}

    <path d="{{pointer_line_path}}" class="pointer-line-background"   />
    <path d="{{pointer_line_path}}" class="pointer-line"  />
  </svg>

  <div class="explain-container">
    <p id="vector-expl">
      We usually think of activations as abstract vectors:
    </p>

    <p id="abstract-vector">a<sub>{{pos[1]}},{{pos[0]}}</sub> = {{present_vector_str}}</p>

    <p>
      Unfortunately, this abstract representation renders activations an inscrutable cube of numbers and has led to concerns that neural networks are a black box.
    </p>

    <p>
      Our first building block offers a promising way forward. Feature visualization makes activations meaningful by showing us <em>what</em> each neuron is looking for:
    </p>
  </div>
</div>

<div class="top-neurons">
  <div class="neurons-sum">
    {{#each tops as top}}
    <div class="neuron">
      <div class="bar" style="height: {{top[1]/max_act*40}}px;"></div>
      <div class="spacer"></div>
      <span>{{(top[1]+'').slice(0,4)}} </span>
      <Sprite src_class="sprite_mixed4d_neuron" n={{top[0]}} size="110" sprite_size="110" />
    </div>

    <p class="annotation"> + </p>
    {{/each}}

    <p class="annotation">...</p>
  </div>

  <svg width="100" height="300">
    <defs>
      <marker id="arrowhead" viewBox="0 0 10 10" refX="1" refY="5" markerWidth="6" markerHeight="6" orient="auto">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="#999" />
      </marker>
    </defs>
    <path d="M35,83 C97,101 72,206 10,210" marker-end="url(#arrowhead)" stroke="#999" fill="transparent" stroke-width="2" />
  </svg>
</div>

<style>
.act-expl {
  position: relative;
  width: 100%;
  height: var(--img-size);
}

.image-container, .pointer-container, .explain-container { 
  position: absolute;
  height: var(--img-size);
}

.image-container {
  width: var(--img-size);
}

.pointer-container {
  width: var(--ptr-size);
}

.explain-container{
  top: -8px;
  left: calc(var(--ptr-size) - 20px);
  right: 0;
}

#vector-expl { margin-bottom: 0; }

.pointer-container rect {
  opacity: 0;
}
.pointer-container .selected {
  opacity: 1;
  fill: white;
  fill: rgba(255, 255, 255, 0.5);
  stroke: black;
  stroke-width: 0.01px;
}
.pointer-container .background{
  opacity: 0.8;
  fill: none;
  stroke: white;
  stroke-width: 0.03px;
  filter: url(#background-rect-blur);
}
.pointer-container .pointer-line-background {
  opacity: 1;
  stroke: white;
  stroke-width: 0.04px;
  filter: url(#background-rect-blur);
  fill: none;
}
.pointer-container .pointer-line {
  opacity: 1;
  fill: none;
  stroke: black;
  stroke-width: 0.02px;
}

#abstract-vector {
  display: inline-block;
  white-space: nowrap;
  margin: 10px;
  margin-left: 0px;
  font-family: monospace;
}

.top-neurons { 
  position: relative; 
  width: calc(100% + 70px);
}
  
.neurons-sum {
  display: flex;
  align-items: center;
  color: #666;
}

.neuron {
  width: 110px; 
  margin-right: 10px;
}

.annotation {
  margin-top: 40px;
  margin-right: 10px;
}

.spacer {
  display: inline-block;
  background: #fff;
  width: 1px;
  height: 40px;
}

.bar {
  display: inline-block; 
  background-color: #999; 
  width: 20px;  
  margin-right: 2px; 
  margin-bottom: -2px;
}

span {
  font-size: 90%;
}

.top-neurons svg {
  position: absolute;
  top: 0;
  right: 0;
}

sub { font-size: 65%; }
</style>

<script>
  import {argmax} from 'ndarray-ops';
  import Sprite from './Sprite.html'
  import {INIT_EXAMPLE, present_vector, range, tops, fmtAct} from '../util';
  const examples = require('../../static/examples');
  
  export default {
    data() {
      return {
        N: [14, 14],
        pos: [2,3],
        example: INIT_EXAMPLE,
        max_act: undefined,
        sizes: {
          img: examples.input_size,
          ptr: 300
        }
      };
    },
    computed: {
      activation (example) {
        return require(`numpy-loader?embed=true!../../static/examples/activations/${example}/mixed4d.npy`)
      },

      max_act (activation) {
        return activation.get(...argmax(activation))
      },

      pointer_line_path: (N, pos) => {
        var top_y = 2.5;
        var start_y = Math.min(Math.max(1.7, pos[1]), pos[1]+1);
        var y_dist = Math.abs(start_y - top_y);
        var main_x_start = Math.min(N[0] + 0.5, pos[0] + 1 + y_dist);  
        return `M ${pos[0]+1} ${start_y} L ${main_x_start} ${top_y} L ${N[0]+1.5} ${top_y}`
      },

      present_vector: (pos, activation) => present_vector(pos, activation),

      present_vector_str: (pos, present_vector) => {
        let s = '['         
        for (let n = 0; n < Math.min(12, present_vector.length); n++) {
          if (n > 0) s += ', ';
          s += fmtAct(present_vector[n]);
        }

        return s + ', ...]';
      },

      tops: (present_vector) => tops(present_vector)
    },
    components: {Sprite},
    helpers: {range},
  }
</script>
