<:Window on:resize="measure()" />

<div ref:root class="container" style="grid-column: screen; --img-size: {{img_size}}px;" on:click="set({change_label: null})">
  {{#if ready}}

    <!-- Intro -->
    <div class="intro">
      <!-- <div><p>
        In machine learning, we often struggle to answer complex questions about network behavior, such as 
        “Why does a neural network classify this image as a 
        <b>{{left_selected_class_label}}</b>
        and not a
        <b>{{right_selected_class_label}}</b>?” 
        In this first example, we prototype an interface combining feature visualization and class attribution that starts to provide an answer to such questions that would not be possible with either technique in isolation.
      </p></div> -->
      <div>
        <p>
          For instance, by combining feature visualization (<i>what is a neuron looking for?</i>) 
          with attribution (<i>how does it affect the output?</i>), we can explore how 
          the network decides between labels like
          <b>{{left_selected_class_label}}</b> 
          and
          <b>{{right_selected_class_label}}</b>.
        </p>
      </div>

      <div>
        <div ref:input_image class="input_image">
          <img src="examples/input_images/{{$example}}.png" />
          {{#if hover_channel}}
            <Sprite src_class="sprite_mixed4d_activations"
              bg_img="examples/activations/{{$example}}/sprite_mixed4d_activations.png"
              n={{hover_channel}}
              sprite_size={{14}}
              size="{{img_size}}" />
          {{else}}
            <svg viewBox="0 0 14 14" on:mouseleave="set({pos: []})">
              {{#each range(14) as x}}
              {{#each range(14) as y}}
                <rect x="{{x}}" y="{{y}}" width="1" height="1"
                  class="{{(x == pos[0] && y == pos[1]) ? 'selected' : ''}}"
                  on:mouseover="set({pos: [x,y]})"></rect>
              {{/each}}
              {{/each}}
            </svg>
          {{/if}}
        </div>
      </div>
      <div>
        <ExamplePicker />
      </div>
    </div>


    <div class="table">

      <div class="cell">
        <div>
          <h4>channels that most support …</h4>
        </div>
      </div>
      <!-- Headers -->
      <div class="headers">
        <div class="cell left">
          <div>
            <div class="wrapper">
              <select bind:value="left_selected_class">
                {{#each left_classes as c}}
                <option value="{{c.c}}" disabled={{c.c===right_selected_class}}>{{c.label}}</option>
                {{/each}}
              </select>
            </div>
          </div>
          <div class="arrow_container">
            <svg class="arrow" width="1000" height="12">
              <path d="M0,6L1000,6M6,0L0,6L6,12" />
            </svg>
          </div>
        </div>

        <div class="flow">
          <svg width="40" height="120">
            <path d="M20,0 L20,108 S20,118 10,118 L0,118 M20,108 S20,118 30,118 L40,118" />
          </svg>
        </div>

        <div class="cell right">
          <div class="arrow_container">
            <svg class="arrow" width="1000" height="12">
              <path d="M0,6L1000,6M994,0L1000,6L994,12" />
            </svg>
          </div>
          <div>
            <div class="wrapper">
              <select bind:value="right_selected_class">
                {{#each right_classes as c}}
                <option value="{{c.c}}" disabled={{c.c === left_selected_class}}>{{c.label}}</option>
                {{/each}}
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Chooser -->
      <!-- <div style="display: flex; justify-content: space-evenly; flex-direction: row; align-items: center; grid-column: middle;margin-bottom: 10px;background: rgba(0, 0, 0, 0); border-radius: 4px; height: 14px;">
        {{#each channels as channel}}
        <div class="channel" style="width: 2px; height: 2px; background: black;"></div>
        {{/each}}
      </div> -->

      <!-- Feature Viz -->

      <div class="row_label cell">
        feature visualization
        <div class="prompt">
          hover for attribution maps
          <svg width=14 height=18>
            <path d="M0,9 L12,9 M9,6 L12,9 L9,12"/>
          </svg>
        </div>
      </div>
      <div class="features" on:mouseleave="set({hover_channel: null})">
        {{#each left_selected_data as d, i}}
          <div class="cell neuron {{hover_channel === d.c ? 'neuron_hover' : ''}}" style="height: {{neuron_img_size}}px;"on:mouseover="set({hover_channel: d.c})" title="Layer mixed4d, Unit {{d.c}}">
            <Sprite src_class="sprite_mixed4d_channel" n={{d.c}} size="{{neuron_img_size}}" sprite_size="110" />
          </div>
        {{/each}}
        <div class="divider"></div>
        {{#each right_selected_data as d, i}}
        <div class="cell neuron {{hover_channel === d.c ? 'neuron_hover' : ''}}" style="height: {{neuron_img_size}}px;"on:mouseover="set({hover_channel: d.c})" title="Layer mixed4d, Unit {{d.c}}">
          <Sprite src_class="sprite_mixed4d_channel" n={{d.c}} size="{{neuron_img_size}}" sprite_size="110" />
        </div>
        {{/each}}
      </div>


      <!-- Evidence -->
      <div class="row_label cell">net evidence</div>
      <div class="evidence net">
        {{#each left_selected_data as d, i}}
          <div class="cell value">
            <span class="swatch" style="opacity: {{evidence_opacity(Math.abs(d.nv0 - d.nv1))}};"></span>
            <span>{{evidence_format(Math.abs(d.nv0 - d.nv1))}}</span>
          </div>
        {{/each}}
        <div class="divider"></div>
        {{#each right_selected_data as d, i}}
          <div class="cell value">
            <span class="swatch" style="opacity: {{evidence_opacity(Math.abs(d.nv0 - d.nv1))}};"></span>
            <span>{{evidence_format(Math.abs(d.nv0 - d.nv1))}}</span>
          </div>
        {{/each}}
      </div>

      <div class="row_label cell">for "{{left_selected_class_label}}"</div>
      <div class="evidence">
        {{#each left_selected_data as d, i}}
          <div class="cell value">
            <span class="swatch" style="background-color: {{d.nv0 > 0 ? 'var(--blue)' : 'var(--orange)'}};opacity: {{evidence_opacity(Math.abs(d.nv0))}};"></span>
            <span>{{evidence_format(d.nv0)}}</span>
          </div>
        {{/each}}
        <div class="divider"></div>
        {{#each right_selected_data as d, i}}
          <div class="cell value">
            <span class="swatch" style="background-color: {{d.nv0 > 0 ? 'var(--blue)' : 'var(--orange)'}};opacity: {{evidence_opacity(Math.abs(d.nv0))}};"></span>
            <span>{{evidence_format(d.nv0)}}</span>
          </div>
        {{/each}}
      </div>

      <div class="row_label cell">for "{{right_selected_class_label}}"</div>
      <div class="evidence">
        {{#each left_selected_data as d, i}}
          <div class="cell value">
            <span class="swatch" style="background-color: {{d.nv1 < 0 ? 'var(--blue)' : 'var(--orange)'}};opacity: {{evidence_opacity(Math.abs(d.nv1))}};"></span>
            <span>{{evidence_format(d.nv1)}}</span>
          </div>
        {{/each}}
        <div class="divider"></div>
        {{#each right_selected_data as d, i}}
          <div class="cell value">
            <span class="swatch" style="background-color: {{d.nv1 < 0 ? 'var(--blue)' : 'var(--orange)'}};opacity: {{evidence_opacity(Math.abs(d.nv1))}};"></span>
            <span>{{evidence_format(d.nv1)}}</span>
          </div>
        {{/each}}
      </div>
    </div>


    <!-- Caption -->
    
    <!-- <p class="caption">
      By combining feature visualization with class attribution we can see which channels lead to the classsification. In this
      instance it’s clear that the network is using “ear shape” to distinguish between the two difference animals.
    </p> -->


  {{else}}
    Loading
  {{/if}}
</div>

<figcaption class="l-body" style="margin-bottom: 10px;">
  Reproduce channel attribution in a
  <a href="https://goo.gl/gnCfGL" style="border: none;">
    <img src="images/colab.svg" alt="" style="height: 13px; width: auto;" />
  </a>
  <a href="https://goo.gl/gnCfGL">
    Colaboratory Notebook.
  </a>
</figcaption>

<style>
  p {
    text-align: left;

  }
    .container {
    margin: 40px 20px;
    position: relative;
    --blue: #3497FF;
    --orange: #ff6600;
  }

  .intro {
    max-width: 1000px;
    margin: 0 auto;
  }
  .table {
    max-width: 1000px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 140px 1fr;
    grid-gap: 0 10px;
  }



  .intro {
    grid-column: middle;
    display: grid;
    grid-template-columns: 1.7fr 1fr 1fr;
    grid-column-gap: 30px;
  }

  .intro p {
    font-size: 1rem;
  }

  .intro b {
    white-space: nowrap;
  }

  .intro figcaption {
    margin-top: 10px;
  }

  .example_picker { 
    width: inherit!important; 
  }

  .input_image {
    position: relative;
    z-index: 100;
    width: 100%;
    position: relative;
    margin-right: 30px;
  }

  .input_image img {
    border-radius: var(--border-radius);
  }

  .input_image .outer {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 100;
    opacity: 0.8;
    mix-blend-mode: multiply;
    image-rendering: optimizeSpeed;             /* STOP SMOOTHING, GIVE ME SPEED  */
    image-rendering: -moz-crisp-edges;          /* Firefox                        */
    image-rendering: -o-crisp-edges;            /* Opera                          */
    image-rendering: -webkit-optimize-contrast; /* Chrome (and eventually Safari) */
    image-rendering: pixelated; /* Chrome */
    image-rendering: optimize-contrast;         /* CSS3 Proposed                  */
    -ms-interpolation-mode: nearest-neighbor;   /* IE8+                           */
    border-radius: var(--border-radius);
    overflow: hidden;
  }

  .input_image svg {
    position: absolute;
    top: 0;
    right: 0;
  }

  .input_image rect { opacity: 0; }

  .input_image rect.selected {
    opacity: 1;
    fill: rgba(255, 255, 255, 0.5);
    stroke: black;
    stroke-width: 0.01px;
  }

  h4 {
    line-height: 1.2em;
    margin: 0 0 8px;
    position: relative; 
    top: 2px; 
    font-weight: 700; 
    font-size: 14px; 
    text-transform: uppercase;
  }



  .row_label {
    position: relative;
  }

  .row_label .prompt {
    font-size: 12px;
    line-height: 1.2em;
    position: absolute;
    bottom: 20%;
    right: 0;
    max-width: 100px;
    font-style: italic;
    opacity: 0.5;
    padding-right: 15px;
  }

  .row_label .prompt svg {
    position: absolute;
    right: 0px;
    top: 1em;
  }

  .row_label .prompt svg path {
    fill: none;
    stroke: black;
  }

  .headers {
    display: grid;
    grid-template-columns: 1fr 0px 1fr;
    grid-column-gap: 20px;
  }

  .headers .flow {
    position: relative;
  }

  .headers .flow svg {
    position: absolute;
    bottom: 29px;
    left: -20px;
  }
  .headers .left {
    display: grid;
    grid-template-columns: 1fr 0.6fr;
  }

  .headers .right {
    display: grid;
    grid-template-columns: 0.6fr 1fr;
  }
  .headers > * {
    position: relative;
  }
  .headers .arrow_container {
    position: relative;
    overflow: hidden;
  }
  .headers .left .arrow {
    position: absolute;
    bottom: 20px;
    left: 20px;
  }
  .headers .right .arrow {
    position: absolute;
    bottom: 20px;
    right: 20px;
  }
  .headers svg path {
    fill: none;
    stroke: rgba(0, 0, 0, 0.4);
    /* shape-rendering: crispEdges; */
  }
  .headers :last-child {
    text-align: right;
  }

  .headers span {
    font-size: 13px;
    display: block;
  }

  .headers select {
    display: inline-block;
    width: 100%;
  }

  .headers select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background: rgba(255, 255, 255, 0.75);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 6px;
    padding: 0.5em 2em 0.5em 0.8em;
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.05);
    margin: 2px 0 2px 0;
  }

  .headers .left select {
    color: var(--blue);
  }

  .headers .right select {
    color: var(--orange);
  }

  .headers .wrapper {position:relative; display: inline;}

  .headers .wrapper:after {content:""; width:0; height:0; position:absolute; pointer-events: none;}

  .headers .wrapper:after {
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      top: .3em;
      right: .75em;
      border-top: 8px solid black;
      opacity: 0.4;
  }

  .headers select::-ms-expand {
      display: none;
  }

  .divider {
    border-left: 1px solid rgba(0, 0, 0, 0.3);
  }

  .features {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 0px 1fr 1fr 1fr;
    grid-column-gap: 15px;
  }

  .evidence {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 0px 1fr 1fr 1fr;
    grid-column-gap: 15px;
  }

  .cell {
    line-height: 1.7em;
    font-size: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    padding: 4px 0;
    position: relative;
  }

  .value {
    text-align: center;
    position: relative;
  }

  .value span {
    display: block;
    position: relative;
    width: 100%;
    height: 100%;
  }

  .value span.swatch {
    text-align: center;
    position: absolute;
    width: 100%;
    height: calc(100% - 6px);
    top: 3px;
    border-radius: 3px;
  }

  .evidence.net .value:nth-child(-n+3) .swatch{
    background: var(--blue);
  }

  .evidence.net .value:nth-last-child(-n+3) .swatch{
    background: var(--orange);
  }

  .cell.neuron {
    position: relative;
    justify-content: center;
    cursor: pointer;
    border-radius: 4px;
    overflow: hidden;
    padding: 0;
    margin: 3px 0;
  }

  .neuron.neuron_hover:after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 6px solid rgba(0, 0, 0, 0.4);
    box-sizing: border-box;
  }

  .caption {
    grid-column: middle;
    margin-top: 40px;
  }


</style>

<script>
  import {json as loadJSON} from 'd3-request';
  import {sup} from 'ndarray-ops';

  import {range} from '../util';
  import ExamplePicker from './ExamplePicker.html';
  import StickyPicker from './StickyPicker.html';

  import Sprite from './Sprite.html';

  const examples = require('../../static/examples').examples;

  export default {
    data() {
      return {
        examples,
        attr_data: {classes: []},
        selected_classes: [],
        pos: [],
        img_size: 100,
        neuron_img_size: 100,
        change_label: null,
        loaded: false,
        channels: range(196)
      }
    },

    oncreate() {
      this.store.observe('example', (example) => {
        loadJSON(`examples/attributions/${example}/teaser.json`, (err, attr_data) => {
          // console.log("loaded", attr_data)
          const selected_classes = attr_data.classes.slice(0, 2);
          this.set({
            loaded: true,
            attr_data, 
            left_selected_class: attr_data.classes[0],
            right_selected_class: attr_data.classes[1]
            // hover_channel: attr_data[`${selected_classes[0]}-${selected_classes[1]}`][0].c
          });
        });

        require(`../../static/examples/npy/${example}_teaser.npy`).load((full_attr) => {
          this.set({full_attr});
          this.measure();
        });
      });
    },

    computed: {
      ready(attr_data, $labels, loaded) {
        return loaded && attr_data != null && $labels != null
      },
      labels($labels) {
        return $labels ? $labels : [];
      },
      left_classes(attr_data, labels) {
        return attr_data.classes.map(c => { return {c, label: labels[c]}})
      },
      left_selected_class_label(left_selected_class, labels) {
        return labels[left_selected_class];
      },
      right_selected_class_label(right_selected_class, labels) {
        return labels[right_selected_class];
      },
      right_classes(attr_data, labels) {
        return attr_data.classes.map(c => { return { c, label: labels[c] } })
      },
      selected_classes(left_selected_class, right_selected_class) {
        return [left_selected_class, right_selected_class];
      },
      selected_data(attr_data, selected_classes, pos, full_attr) {
        let data = attr_data[`${selected_classes[0]}-${selected_classes[1]}`];
        if (!data) {
          data = attr_data[`${selected_classes[1]}-${selected_classes[0]}`] || [];
          data = data.slice().reverse();

          if (!pos.length) {
            data = data.map((d) => {
              if (d.nv0) {
                const d2 = Object.assign({}, d);
                const temp = d2.nv0;
                d2.nv0 = d2.nv1;
                d2.nv1 = temp;
                return d2;
              }
              return d;
            });
          }
        }

        if (pos.length) {
          const idx0 = attr_data.classes.indexOf(selected_classes[0]);
          const idx1 = attr_data.classes.indexOf(selected_classes[1]);
          return data.map((d) => {
            const cidx = attr_data.channels.indexOf(d.c);
            return {
              c: d.c,
              nv0: full_attr.get(idx0, pos[1], pos[0], cidx),
              nv1: full_attr.get(idx1, pos[1], pos[0], cidx)
            };
          });
        }

        return data;
      },
      left_selected_data(selected_data) {
        // console.log(selected_data);
        return selected_data.slice(0, 3);
      },
      right_selected_data(selected_data) {
        return selected_data.slice(4, 7);
      },

      change_label_pos(change_label) {
        const label = document.querySelectorAll('p.heading span.label')[change_label];
        return label ? label.getBoundingClientRect() : {};
      }
    },

    methods: {
      change_label(event, idx) {
        this.set({change_label: idx});
        event.stopPropagation();
      },

      select_class(cls) {
        const change_label = this.get('change_label');
        const selected_classes = this.get('selected_classes');
        selected_classes[change_label] = cls;
        this.set({selected_classes, change_label: null, hover_channel: null});
      },

      measure() {
        const neuron_el = this.refs.root.querySelector('.evidence .value');
        const input_image_el = this.refs.input_image;
        this.set({
          neuron_img_size: neuron_el.clientWidth,
          img_size: input_image_el.clientWidth
        })
      }
    },

    helpers: {
      range,
      evidence_opacity(v) {
        return v / 4;
      },
      evidence_format(n) {
        return n.toFixed(2);
      },

      bar_filled(d, cls, base) {
        const val = d[cls] * 100;
        const width = Math.abs(val) / 2;

        const start = cls === base ? 50 :
          Math.sign(val) === Math.sign(d[base]) ? 50 :
            50 + (Math.abs(d[base] * 100) / 2);

        return ((cls === 'nv0' && val > 0) || (cls === 'nv1' && val < 0)) ?
          `right: ${start}%; width: ${width}%` :
          `left: ${start}%; width: ${width}%`;
      }
    },

    components: {ExamplePicker, Sprite, StickyPicker}
  }
</script>
