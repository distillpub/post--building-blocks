<:Window on:resize="measure()" />
<div ref:root class="container base-grid" style="--img-size: {{img_size}}px;" on:click="set({change_label: null})">
  {{#if ready}}

    <!-- Intro -->
    <div class="intro">
      <div><p>
        For instance, by combining feature visualization and class attribution we can 
        start to answer complex questions like, 
        “How does a neural network decide between a 
        <b>{{left_selected_class_label}}</b>
        and a
        <b>{{right_selected_class_label}}</b>?”
      </p></div>
      <div>
        <div ref:input_image class="input_image">
          <img src="examples/input_images/{{$example}}.png" />
          {{#if hover_channel}}
            <Sprite src_class="sprite_mixed4d_activations"
              bg_img="examples/activations/{{$example}}/sprite_mixed4d_activations.png"
              n={{hover_channel}}
              sprite_size={{14}}
              size="{{img_size}}" />
          {{else}}
            <svg viewBox="0 0 14 14" on:mouseleave="set({pos: []})">
              {{#each range(14) as x}}
              {{#each range(14) as y}}
                <rect x="{{x}}" y="{{y}}" width="1" height="1"
                  class="{{(x == pos[0] && y == pos[1]) ? 'selected' : ''}}"
                  on:mouseover="set({pos: [x,y]})"></rect>
              {{/each}}
              {{/each}}
            </svg>
          {{/if}}
        </div>
      </div>
      <div>
        <ExamplePicker />
      </div>
    </div>


    <!-- Headers -->
    <div class="headers">
      <div class="left">
        <span>Channels that most support</span>
        <div class="wrapper">
          <select bind:value="left_selected_class">
            {{#each left_classes as c}} 
            <option value="{{c.c}}" disabled={{c.c === right_selected_class}}>{{c.label}}</option>
            {{/each}}
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <div class="right">
        <span>Channels that most support</span>
        <div class="wrapper">
          <select bind:value="right_selected_class">
            {{#each right_classes as c}}
            <option value="{{c.c}}" disabled={{c.c === left_selected_class}}>{{c.label}}</option>
            {{/each}}
          </select>
        </div>
      </div>
    </div>

    <!-- Feature Viz -->

    <div class="row_label">feature visualization</div>
    <div class="features" on:mouseleave="set({hover_channel: null})">
      {{#each left_selected_data as d, i}}
        <div class="neuron {{hover_channel === d.c ? 'neuron_hover' : ''}}" style="width: {{neuron_img_size}}px; height: {{neuron_img_size}}px;"on:mouseover="set({hover_channel: d.c})" title="Layer mixed4d, Unit {{d.c}}">
          <Sprite src_class="sprite_mixed4d_channel" n={{d.c}} size="{{neuron_img_size}}" sprite_size="110" />
        </div>
      {{/each}}
      <div class="divider"></div>
      {{#each right_selected_data as d, i}}
      <div class="neuron {{hover_channel === d.c ? 'neuron_hover' : ''}}" style="width: {{neuron_img_size}}px; height: {{neuron_img_size}}px;"on:mouseover="set({hover_channel: d.c})" title="Layer mixed4d, Unit {{d.c}}">
        <Sprite src_class="sprite_mixed4d_channel" n={{d.c}} size="{{neuron_img_size}}" sprite_size="110" />
      </div>
      {{/each}}
    </div>


    <!-- Evidence -->
    <div class="row_label">net evidence</div>
    <div class="evidence net">
      {{#each left_selected_data as d, i}}
        <div class="value">
          <span class="background" style="opacity: {{evidence_opacity(Math.abs(d.nv0 - d.nv1))}};"></span>
          <span>{{evidence_format(Math.abs(d.nv0 - d.nv1))}}</span>
        </div>
      {{/each}}
      <div class="divider"></div>
      {{#each right_selected_data as d, i}}
        <div class="value">
          <span class="background" style="opacity: {{evidence_opacity(Math.abs(d.nv0 - d.nv1))}};"></span>
          <span>{{evidence_format(Math.abs(d.nv0 - d.nv1))}}</span>
        </div>
      {{/each}}
    </div>

    <div class="row_label">for "{{left_selected_class_label}}"</div>
    <div class="evidence">
      {{#each left_selected_data as d, i}}
        <div class="value">
          <span class="background" style="background-color: {{d.nv0 > 0 ? 'var(--blue)' : 'var(--orange)'}};opacity: {{evidence_opacity(Math.abs(d.nv0))}};"></span>
          <span>{{evidence_format(d.nv0)}}</span>
        </div>
      {{/each}}
      <div class="divider"></div>
      {{#each right_selected_data as d, i}}
        <div class="value">
          <span class="background" style="background-color: {{d.nv0 > 0 ? 'var(--blue)' : 'var(--orange)'}};opacity: {{evidence_opacity(Math.abs(d.nv0))}};"></span>
          <span>{{evidence_format(d.nv0)}}</span>
        </div>
      {{/each}}
    </div>

    <div class="row_label">for "{{right_selected_class_label}}"</div>
    <div class="evidence">
      {{#each left_selected_data as d, i}}
        <div class="value">
          <span class="background" style="background-color: {{d.nv1 < 0 ? 'var(--blue)' : 'var(--orange)'}};opacity: {{evidence_opacity(Math.abs(d.nv1))}};"></span>
          <span>{{evidence_format(d.nv1)}}</span>
        </div>
      {{/each}}
      <div class="divider"></div>
      {{#each right_selected_data as d, i}}
        <div class="value">
          <span class="background" style="background-color: {{d.nv1 < 0 ? 'var(--blue)' : 'var(--orange)'}};opacity: {{evidence_opacity(Math.abs(d.nv1))}};"></span>
          <span>{{evidence_format(d.nv1)}}</span>
        </div>
      {{/each}}
    </div>


    <!-- Caption -->
    
    <!-- <p class="caption">
      By combining feature visualization with class attribution we can see which channels lead to the classsification. In this
      instance it’s clear that the network is using “ear shape” to distinguish between the two difference animals.
    </p> -->


  {{else}}
    Loading
  {{/if}}
</div>

<style>

  .container {
    margin: 40px 0;
    position: relative;
    --blue: #3497FF;
    --orange: #ff6600;
  }

  .intro {
    grid-column: middle;
    display: grid;
    grid-template-columns: 1.5fr 1fr 1.5fr;
    grid-column-gap: 30px;
  }

  .intro p {
    font-size: 1rem;
  }

  .intro figcaption {
    margin-top: 10px;
  }

  .example_picker { 
    width: inherit!important; 
  }

  .input_image {
    position: relative;
    width: 100%;
    position: relative;
    margin-right: 30px;
  }

  .input_image img {
    border-radius: var(--border-radius);
  }

  .input_image .outer {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 100;
    opacity: 0.8;
    mix-blend-mode: multiply;
    image-rendering: optimizeSpeed;             /* STOP SMOOTHING, GIVE ME SPEED  */
    image-rendering: -moz-crisp-edges;          /* Firefox                        */
    image-rendering: -o-crisp-edges;            /* Opera                          */
    image-rendering: -webkit-optimize-contrast; /* Chrome (and eventually Safari) */
    image-rendering: pixelated; /* Chrome */
    image-rendering: optimize-contrast;         /* CSS3 Proposed                  */
    -ms-interpolation-mode: nearest-neighbor;   /* IE8+                           */
    border-radius: var(--border-radius);
    overflow: hidden;
  }

  .input_image svg {
    position: absolute;
    top: 0;
    right: 0;
  }

  .input_image rect { opacity: 0; }

  .input_image rect.selected {
    opacity: 1;
    fill: rgba(255, 255, 255, 0.5);
    stroke: black;
    stroke-width: 0.01px;
  }

  .row_label {
    font-size: 12px;
    line-height: 1.2em;
    grid-column: screen-start/middle-start;
    text-align: right;
  }

  .headers {
    grid-column: middle;
    display: grid;
    grid-template-columns: 1fr 0px 1fr;
    grid-column-gap: 30px;
  }

  .headers :last-child {
    text-align: right;
  }

  .headers span {
    font-size: 13px;
    display: block;
  }

  .headers select {
    display: inline-block;
    width: 200px;
  }

  .headers select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background: rgba(255, 255, 255, 0.75);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 6px;
    padding: 0.5em 2em 0.5em 0.8em;
    font-size: 16px;
    font-weight: bold;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.05);
    margin: 2px 0 12px 0;
  }

  .headers .left select {
    color: var(--blue);
  }

  .headers .right select {
    color: var(--orange);
  }

  .headers .wrapper {position:relative; display: inline;}

  .headers .wrapper:after {content:""; width:0; height:0; position:absolute; pointer-events: none;}

  .headers .wrapper:after {
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      top: .3em;
      right: .75em;
      border-top: 8px solid black;
      opacity: 0.4;
  }

  .headers select::-ms-expand {
      display: none;
  }

  .divider {
    border-left: 1px solid rgba(0, 0, 0, 0.3);
  }

  .features {
    grid-column: middle;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 0px 1fr 1fr 1fr;
    grid-column-gap: 15px;
    padding-bottom: 4px;
  }

  .evidence {
    grid-column: middle;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 0px 1fr 1fr 1fr;
    grid-column-gap: 15px;
  }

  .evidence .value {
    text-align: center;
    font-size: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    position: relative;
  }

  .evidence .value span {
    display: block;
    position: relative;
    width: 100%;
    height: 100%;
  }

  .evidence .value span.background {
    position: absolute;
    left: 0;
    top: 0;
    border-radius: 4px;
  }

  .evidence.net .value:nth-child(-n+3) .background{
    background: var(--blue);
  }

  .evidence.net .value:nth-last-child(-n+3) .background{
    background: var(--orange);
  }

  .neuron {
    position: relative;
    justify-content: center;
    cursor: pointer;
  }

  .caption {
    grid-column: middle;
    margin-top: 40px;
  }


</style>

<script>
  import {json as loadJSON} from 'd3-request';
  import {sup} from 'ndarray-ops';

  import {range} from '../util';
  import ExamplePicker from './ExamplePicker.html';
  import Sprite from './Sprite.html';

  const examples = require('../../static/examples').examples;

  export default {
    data() {
      return {
        examples,
        attr_data: {classes: []},
        selected_classes: [],
        pos: [],
        img_size: 100,
        neuron_img_size: 100,
        change_label: null,
        loaded: false
      }
    },

    oncreate() {
      this.store.observe('example', (example) => {
        loadJSON(`examples/attributions/${example}/teaser.json`, (err, attr_data) => {
          console.log("loaded", attr_data)
          const selected_classes = attr_data.classes.slice(0, 2);
          this.set({
            loaded: true,
            attr_data, 
            left_selected_class: attr_data.classes[0],
            right_selected_class: attr_data.classes[1]
            // hover_channel: attr_data[`${selected_classes[0]}-${selected_classes[1]}`][0].c
          });
        });

        require(`../../static/examples/npy/${example}_teaser.npy`).load((full_attr) => {
          this.set({full_attr});
          this.measure();
        });
      });
    },

    computed: {
      ready(attr_data, $labels, loaded) {
        return loaded && attr_data != null && $labels != null
      },
      labels($labels) {
        return $labels ? $labels : [];
      },
      left_classes(attr_data, labels) {
        return attr_data.classes.map(c => { return {c, label: labels[c]}})
      },
      left_selected_class_label(left_selected_class, labels) {
        return labels[left_selected_class];
      },
      right_selected_class_label(right_selected_class, labels) {
        return labels[right_selected_class];
      },
      right_classes(attr_data, labels) {
        return attr_data.classes.map(c => { return { c, label: labels[c] } })
      },
      selected_classes(left_selected_class, right_selected_class) {
        return [left_selected_class, right_selected_class];
      },
      selected_data(attr_data, selected_classes, pos, full_attr) {
        let data = attr_data[`${selected_classes[0]}-${selected_classes[1]}`];
        if (!data) {
          data = attr_data[`${selected_classes[1]}-${selected_classes[0]}`] || [];
          data = data.slice().reverse();

          if (!pos.length) {
            data = data.map((d) => {
              if (d.nv0) {
                const d2 = Object.assign({}, d);
                const temp = d2.nv0;
                d2.nv0 = d2.nv1;
                d2.nv1 = temp;
                return d2;
              }
              return d;
            });
          }
        }

        if (pos.length) {
          const idx0 = attr_data.classes.indexOf(selected_classes[0]);
          const idx1 = attr_data.classes.indexOf(selected_classes[1]);
          return data.map((d) => {
            const cidx = attr_data.channels.indexOf(d.c);
            return {
              c: d.c,
              nv0: full_attr.get(idx0, pos[1], pos[0], cidx),
              nv1: full_attr.get(idx1, pos[1], pos[0], cidx)
            };
          });
        }

        return data;
      },
      left_selected_data(selected_data) {
        console.log(selected_data);
        return selected_data.slice(0, 3);
      },
      right_selected_data(selected_data) {
        return selected_data.slice(4, 7);
      },

      change_label_pos(change_label) {
        const label = document.querySelectorAll('p.heading span.label')[change_label];
        return label ? label.getBoundingClientRect() : {};
      }
    },

    methods: {
      change_label(event, idx) {
        this.set({change_label: idx});
        event.stopPropagation();
      },

      select_class(cls) {
        const change_label = this.get('change_label');
        const selected_classes = this.get('selected_classes');
        selected_classes[change_label] = cls;
        this.set({selected_classes, change_label: null, hover_channel: null});
      },

      measure() {
        const neuron_el = this.refs.root.querySelector('.evidence .value');
        const input_image_el = this.refs.input_image;
        this.set({
          neuron_img_size: neuron_el.clientWidth,
          img_size: input_image_el.clientWidth
        })
      }
    },

    helpers: {
      range,
      evidence_opacity(v) {
        return 2 * Math.pow(v, 2);
      },
      evidence_format(n) {
        return n.toFixed(2);
      },

      bar_filled(d, cls, base) {
        const val = d[cls] * 100;
        const width = Math.abs(val) / 2;

        const start = cls === base ? 50 :
          Math.sign(val) === Math.sign(d[base]) ? 50 :
            50 + (Math.abs(d[base] * 100) / 2);

        return ((cls === 'nv0' && val > 0) || (cls === 'nv1' && val < 0)) ?
          `right: ${start}%; width: ${width}%` :
          `left: ${start}%; width: ${width}%`;
      }
    },

    components: {ExamplePicker, Sprite}
  }
</script>
